"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}var FullScreenHandler=function(){function t(e){_classCallCheck(this,t),this.painel=this.createPanel(),this.imgSources=e.toArray().map(function(e){return e.src})}return _createClass(t,[{key:"toggleFullScreen",value:function(e){var t=this.painel.get(0);this.painel.show(),this.setImageSource(e),document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement?(this.exitFullScreen(),document.cancelFullScreen?document.cancelFullScreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen()):t.requestFullscreen?t.requestFullscreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.webkitRequestFullscreen&&t.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT)}},{key:"setImageSource",value:function(e){this.painel.show(),this.painel.find("#full-screen__image").attr("src",this.imgSources[e]),this.active=e}},{key:"exitFullScreen",value:function(){this.active=null,this.painel.hide()}},{key:"createPreviousButton",value:function(){var t=this;return $('<button  class="button buttonAction partitura-download">Anterior</button> ').on("click",function(e){return t.previousSheet()})}},{key:"createNextButton",value:function(){var t=this;return $('<button  class="button buttonAction partitura-download">Pr√≥ximo</button> ').on("click",function(e){return t.nextSheet()})}},{key:"createExitButton",value:function(){var t=this;return $('<button  class="button buttonAction partitura-download">Sair</button> ').on("click",function(e){return t.toggleFullScreen()})}},{key:"createPanel",value:function(){return $('<div class="full-screen__panel">\n\t\t\t\t<img id="full-screen__image" class="full-screen__image" src="" alt="">\n\t\t\t\t<div class="full-screen__actions">\n\t\t\t\t</div> \n\t\t\t</div>').hide().insertAfter(".task").find(".full-screen__actions").append(this.createPreviousButton()).append(this.createExitButton()).append(this.createNextButton()),$(".full-screen__panel")}},{key:"isInFullScreen",value:function(){return null!=document.webkitFullscreenElement||null!=document.mozFullScreenElement||null!=document.msFullscreenElement}},{key:"refreshListener",value:function(){var t=this;$("body").on("keyup",function(e){t.isInFullScreen()&&("37"==e.which||"40"==e.which?t.previousSheet():"38"==e.which||"39"==e.which?t.nextSheet():"27"==e.which&&t.toggleFullScreen())}),document.addEventListener("fullscreenchange",function(e){return!t.isInFullScreen()&&t.exitFullScreen()}),document.addEventListener("mozfullscreenchange",function(e){return!t.isInFullScreen()&&t.exitFullScreen()}),document.addEventListener("webkitfullscreenchange",function(e){return!t.isInFullScreen()&&t.exitFullScreen()})}},{key:"nextSheet",value:function(){this.active=(this.active+1)%this.imgSources.length,this.setImageSource(this.active)}},{key:"previousSheet",value:function(){this.active=Math.abs((this.active-1)%this.imgSources.length),this.setImageSource(this.active)}}]),t}(),MusicSheet=function(){function t(){var e=this;_classCallCheck(this,t),this.partituras=$(".partitura"),this.elements={musicSheets:function(){return e.partituras}},this.taskTitle=$(".task-body-header-title-text").text(),this.settings=$(".settings-box-list"),this.fullScreenHandler=new FullScreenHandler(this.partituras),this.fullScreenHandler.refreshListener()}return _createClass(t,[{key:"init",value:function(){this.setupListeners(),this.createDownloadButtons(),1<this.partituras.length&&this.createDownloadsSettings()}},{key:"createDownloadButtons",value:function(){var l=this;this.elements.musicSheets().each(function(n,i){var e=i.src,a=i.alt||"".concat(l.taskTitle," - partitura ").concat(n+1,".").concat(e.split(".").pop());l.isMobile()?$(i).after("<div class=\"partitura-download__wrapper\"><a class='button buttonAction partitura-download' href='".concat(e,"' download='").concat(a,"' title='").concat(a,"' target='_blank'>Download</a></div>")):l.toDataURL(e,function(e){var t="<button class='button buttonAction partitura-download' id='sheet-view-".concat(n,"' title='").concat(a,"'>Visualizar</button>"),e="<a class='button buttonAction partitura-download' href='".concat(e,"' download='").concat(a,"' title='").concat(a,"' target='_blank'>Download</a>");$(i).after('<div class="partitura-download__wrapper">'.concat(e," ").concat(t,"</div>")),$("#sheet-view-".concat(n)).on("click",function(e){return l.fullScreenHandler.toggleFullScreen(n)})})})}},{key:"createDownloadsSettings",value:function(){var t=this;$('<li class="settings-box-item settings-box-item-partituras"><button class="download-partituras">Baixar todas as imagens</button></li>').on("click",function(e){return t.downloads()}).appendTo(this.settings)}},{key:"toDataURL",value:function(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"jpg",i=new Image;i.crossOrigin="Anonymous",i.onload=function(){var e=document.createElement("CANVAS");e.height=this.naturalHeight,e.width=this.naturalWidth,e.getContext("2d").drawImage(this,0,0);e=e.toDataURL(n);t(e)},i.src=e+"?"+Math.random()}},{key:"downloads",value:function(){$("a.partitura-download").each(function(){$(this)[0].click()})}},{key:"isMobile",value:function(){return 0==document.location.pathname.indexOf("/mobile/")}},{key:"setupListeners",value:function(){var n=this;this.elements.musicSheets().each(function(t,e){return $(e).on("click",function(e){return n.fullScreenHandler.toggleFullScreen(t)})})}}]),t}();(new MusicSheet).init();