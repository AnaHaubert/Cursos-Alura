"use strict";function _slicedToArray(t,e){return _arrayWithHoles(t)||_iterableToArrayLimit(t,e)||_unsupportedIterableToArray(t,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Map"===(n="Object"===n&&t.constructor?t.constructor.name:n)||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(t,e):void 0}}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,a=new Array(e);n<e;n++)a[n]=t[n];return a}function _iterableToArrayLimit(t,e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t)){var n=[],a=!0,o=!1,s=void 0;try{for(var l,i=t[Symbol.iterator]();!(a=(l=i.next()).done)&&(n.push(l.value),!e||n.length!==e);a=!0);}catch(t){o=!0,s=t}finally{try{a||null==i.return||i.return()}finally{if(o)throw s}}return n}}function _arrayWithHoles(t){if(Array.isArray(t))return t}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var n=0;n<e.length;n++){var a=e[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}function _createClass(t,e,n){return e&&_defineProperties(t.prototype,e),n&&_defineProperties(t,n),t}var AutoPlay=function(){function r(t,e,n,a,o,s,l){_classCallCheck(this,r);var i=_slicedToArray(s.nextTaskModal.nextTaskCountDownTitle?s.nextTaskModal.nextTaskCountDownTitle.match(/\d+/):"8",1)[0];this.nextTaskId=t,this.nextTaskTitle=e,this.nextTaskDuration=n,this.autoPlayType=a,this.messages=s,this.eventListener=l,this.storageKey="autoplay-timeout",this.nextTaskAlert=null,this.stillHereModal=null,this.canLoadNextTask=!!t,this.stillHereModalTimeout=18e5,this.nextTaskAlertTimeout=1e3*parseInt(i),this.nextTaskCountDownInSeconds=parseInt(i),this.currentTask=o,this.registerComponents()}return _createClass(r,[{key:"hasNextTask",value:function(){return!!this.nextTaskId}},{key:"loadNextTask",value:function(){var t;this.hasNextTask()&&this.canLoadNextTask&&(t=window.location.href.replace(/[0-9]+$/,this.nextTaskId),window.location.href=t)}},{key:"cancelLoadNextTask",value:function(){this.canLoadNextTask=!1,clearTimeout(this.countDownTimeoutId),clearInterval(this.countDownIntervalId),this.timerText.trigger("cancel"),this.nextTaskAlert.close()}},{key:"handleMenuItemsClick",value:function(t,e){var n=this;t.preventDefault(),$(".vjs-autoplay-menu + .vjs-menu .vjs-menu-item.vjs-selected").toggleClass("vjs-selected"),("SPAN"===t.target.tagName?$(t.target).parent():$(t.target)).toggleClass("vjs-selected"),this.eventListener.ga(e,"autoplaychange"),$.post("/user/profile/setAutoPlayType",{autoPlayType:e,taskId:this.currentTask}).done(function(t){return n.updateInfo(e,t)})}},{key:"updateInfo",value:function(t,e){this.cancelLoadNextTask(),this.autoPlayType=t,this.nextTaskId=void 0,this.nextTaskTitle=void 0,this.nextTaskDuration=void 0,"NONE"!==this.autoPlayType&&e&&(this.nextTaskId=e.id,this.nextTaskTitle=e.title,e.duration&&(this.nextTaskDuration=e.duration),e=this.nextTaskTitle,this.nextTaskDuration&&(e=e.concat(" (".concat(this.nextTaskDuration,"min)"))),this.nextTaskButton.controlText(e))}},{key:"buildMenuItems",value:function(t){var n=this,e=videojs.getComponent("MenuItem"),a=this.messages.options,o=a.optionNone,s=a.optionTasks,a=a.optionVideos,s=[new e(t,{label:o,multiSelectable:!1,selectable:!0,selected:"NONE"===this.autoPlayType,autoPlayType:"NONE"}),new e(t,{label:a,multiSelectable:!1,selectable:!0,selected:"VIDEOS"===this.autoPlayType,autoPlayType:"VIDEOS"}),new e(t,{label:s,multiSelectable:!1,selectable:!0,selected:"TASKS"===this.autoPlayType,autoPlayType:"TASKS"})];return s.forEach(function(e){return e.on("click",function(t){n.handleMenuItemsClick(t,e.options_.autoPlayType)})}),s}},{key:"setModalTimeout",value:function(t){var e=(new Date).getTime()+this.stillHereModalTimeout;t.setItem(this.storageKey,e)}},{key:"shouldShowModal",value:function(t){var e=t.getItem(this.storageKey),n=(new Date).getTime();if(null===e)return this.setModalTimeout(t),!1;n=e<n;return n&&this.setModalTimeout(t),n}},{key:"configureComponents",value:function(t,e){this.updateAutoplayMenu(e),this.shouldShowModal(t),this._buildStillHereModal(e),this._buildNextTaskAlert(e),this._configureEventsOnPlayer(e,t)}},{key:"_configureEventsOnPlayer",value:function(t,e){var n,a=this;t.on("play",function(){a.canLoadNextTask=a.hasNextTask(),n=setInterval(function(){a.shouldShowModal(e)&&a.stillHereModal.open()},a.stillHereModalTimeout)}),t.on("pause",function(){clearInterval(n)}),t.on("ended",function(){var t,e;a.hasNextTask()&&(a.nextTaskAlert.open(),e=(t=document.querySelector(".border-continue-button")).getTotalLength(),t.style.strokeDasharray=e,t.style.strokeDashoffset=e,a.countDownIntervalId=setInterval(function(){return a.timerText.trigger("countdown")},1e3),a.countDownTimeoutId=setTimeout(function(){a.loadNextTask()},a.nextTaskAlertTimeout))})}},{key:"_buildNextTaskAlert",value:function(t){var e=this,n=this.messages.nextTaskModal,a=n.cancelText,o=n.continueText,n=n.nextTaskModalTitle,n="".concat(n);this.nextTaskAlert=this.buildModal(t,{modalContent:n,modalOptions:{temporary:!1},modalCSSClass:"autoplay-alert",modalEvent:"click",modalEventHandler:function(){}});t=this.nextTaskTitle;this.nextTaskDuration&&(t=t.concat(" (".concat(this.nextTaskDuration,"min)")));var s=this.nextTaskAlert.addChild("Button");s.countDownTotal=this.nextTaskCountDownInSeconds,s.controlText(this.messages.nextTaskModal.nextTaskCountDownTitle),s.addClass("next-task-timer-text"),s.on("cancel",function(t){s.countDownTotal=e.nextTaskCountDownInSeconds,document.querySelector(".next-task-timer-text .vjs-control-text").innerText=e.messages.nextTaskModal.nextTaskCountDownTitle}),s.on("countdown",function(){--s.countDownTotal,0<s.countDownTotal&&(document.querySelector(".next-task-timer-text .vjs-control-text").innerText=e.messages.nextTaskModal.nextTaskCountDownTitle.replace(/\d+/,s.countDownTotal))}),this.timerText=s;n=this.nextTaskAlert.addChild("Button");n.controlText(t),n.addClass("autoplay-nexttask-button"),n.on("click",function(){return e.loadNextTask()}),this.nextTaskButton=n;var l=this.nextTaskAlert.addChild("ClickableComponent");l.controlText(o),l.addClass("autoplay-continue-button"),l.on("click",function(){return e.loadNextTask()}),fetch("/assets/images/video/autoplay-continue-icon.svg").then(function(t){return t.text()}).then(function(t){return l.el_.children[0].innerHTML=t});o=this.nextTaskAlert.addChild("Button");o.controlText(a),o.addClass("autoplay-cancel-button"),o.on("click",function(){return e.cancelLoadNextTask()})}},{key:"_buildStillHereModal",value:function(t){var e=this.messages.stillHereModal.stillHereModalText;this.stillHereModal=this.buildModal(t,{modalContent:e,modalOptions:{temporary:!1},modalCSSClass:"autoplay-not-watching-alert",modalEvent:"click",modalEventHandler:function(t,e){e.close(),t.focus(),t.play()}}),this.stillHereModal.addChild("BigPlayButton")}},{key:"buildModal",value:function(e,n){var a=e.createModal(n.modalContent,n.modalOptions);return a.close(),a.addClass(n.modalCSSClass),a.on(n.modalEvent,function(t){t.preventDefault(),n.modalEventHandler(e,a,t)}),a}},{key:"registerComponents",value:function(){var t=videojs.getComponent("MenuButton"),e=videojs.extend(t,{constructor:function(){t.apply(this,arguments)},buildCSSClass:function(){return"vjs-autoplay-menu"}});videojs.registerComponent("menuAutoPlay",e)}},{key:"updateAutoplayMenu",value:function(t){var e=this,n=t.controlBar.getChild("menuAutoPlay");n.createItems=function(){return e.buildMenuItems(t)},n.update()}}]),r}();