"use strict";function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);return"Map"===(a="Object"===a&&e.constructor?e.constructor.name:a)||"Set"===a?Array.from(e):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,o=new Array(t);a<t;a++)o[a]=e[a];return o}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var a=0;a<t.length;a++){var o=t[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function _createClass(e,t,a){return t&&_defineProperties(e.prototype,t),a&&_defineProperties(e,a),e}var VideoPlayer=function(){function e(){_classCallCheck(this,e),window.HELP_IMPROVE_VIDEOJS=!1,this.$videoData=$("#video-container-data"),this.lastMomentManager=new LastMomentManager("last-seen-videos"),this.maxPlaybackRate=this.$videoData.data("max-playback-rate"),this.playbackRate=this.$videoData.data("playback-rate"),this.DEFAULT_PLAYBACK_RATES=[.25,.5,.75,1,1.25,1.5,1.75,2,2.5,3],this.quality=this.$videoData.data("quality"),this.gnarusName=this.$videoData.data("gnarus-name"),this.extraContentId=this.$videoData.data("extra-content-id"),this.taskId=this.$videoData.data("task-id"),this.immersionClassId=this.$videoData.data("immersion-class-id"),this.sectionId=this.$videoData.data("section-id"),this.courseId=this.$videoData.data("course-id"),this.courseCode=this.$videoData.data("course"),this.url=this.buildURL(),this.category=this.buildCategory(),this.label=this.buildLabel(),this.customErrorMessage=this.$videoData.data("error-message"),this.customErrorLabel=this.$videoData.data("error-label"),this.playbackRates=this.buildPlaybackRates(),this.nextTaskId=this.$videoData.data("next-task-id"),this.nextTaskTitle=this.$videoData.data("next-task-title"),this.nextTaskDuration=this.$videoData.data("next-task-duration"),this.autoPlayType=this.$videoData.data("autoplay-type"),this.isAutoPlayEnabled=this.$videoData.data("autoplay-enabled"),this.autoPlay=null,this.setupAutoPlay(),this.isOnPreviewMode=this.$videoData.data("preview-mode")||!1}return _createClass(e,[{key:"buildURL",value:function(){return this.extraContentId?"/extracontent/".concat(this.extraContentId,"/video"):this.immersionClassId?"/immersionclass/".concat(this.immersionClassId,"/video"):"/course/".concat(this.courseCode,"/task/").concat(this.taskId,"/video")}},{key:"buildCategory",value:function(){return this.extraContentId?"extra-content-video":this.immersionClassId?"immersion-class-video":"course-video"}},{key:"buildLabel",value:function(){return this.extraContentId?"extra-content-".concat(this.extraContentId):this.immersionClassId?"immersion-class-".concat(this.immersionClassId):"course-".concat(this.courseId," section-").concat(this.sectionId)}},{key:"buildPlaybackRates",value:function(){var t=this;return this.maxPlaybackRate?this.DEFAULT_PLAYBACK_RATES.filter(function(e){return e<=t.maxPlaybackRate}):this.DEFAULT_PLAYBACK_RATES}},{key:"build",value:function(){var t=this;$.get(this.url,function(e){return t.buildPlayer(e)}).fail(function(e){return console.log(e)})}},{key:"buildWithId",value:function(e,t){var a=this;this.diagnostic=t;e=document.getElementById(e);$(e).on("contextmenu",function(e){e.preventDefault()}),this.myPlayer=videojs(e,{fluid:!0,controls:!0,autoplay:!1,preload:"auto",playbackRates:this.playbackRates,controlBar:{children:["progressControl","playToggle","volumePanel","currentTimeDisplay","timeDivider","durationDisplay","PlaybackRateMenuButton","qualitySelector","pictureInPictureToggle","theaterModeToggle","fullscreenToggle"]},html5:{hls:{overrideNative:!0}},userActions:{hotkeys:function(e){38==e.keyCode&&(e.preventDefault(),a.changeVolume(.1)),40==e.keyCode&&(e.preventDefault(),a.changeVolume(-.1))}}}),this.setupError(),this.setupPersistVolume(),this.setupHotKeys(),this.myPlayer.on("qualitySelected",function(e,t){return a.updateUserPreferences(t)})}},{key:"buildPlayer",value:function(e){var a=this;$("#loading").remove(),this.$videoData.append('\n          <video-js id="video-player" class="video-js vjs-big-play-centered vjs-default-skin video-player-frame video-player"  oncontextmenu="return false;" preload="auto" controls controlsList="nodownload" >\n           </video-js>\n        '),this.$videoData.on("contextmenu",function(e){e.preventDefault()}),this.myPlayer=videojs(document.getElementById("video-player"),{fluid:!0,controls:!0,autoplay:this.isAutoPlayEnabled&&"NONE"!=this.autoPlayType,preload:"auto",playbackRates:this.playbackRates,controlBar:{children:["progressControl","playToggle","volumePanel","currentTimeDisplay","timeDivider","durationDisplay","menuAutoPlay","PlaybackRateMenuButton","qualitySelector","pictureInPictureToggle","theaterModeToggle","fullscreenToggle"]},html5:{vhs:{overrideNative:!0}},userActions:{hotkeys:function(e){38==e.keyCode&&(e.preventDefault(),a.changeVolume(.1)),40==e.keyCode&&(e.preventDefault(),a.changeVolume(-.1))}}}),this.setupError(),this.myPlayer.src(this.buildSources(e)),this.setupWatched(),this.setupPersistVolume(),this.setupHotKeys(),this.myPlayer.on("qualitySelected",function(e,t){return a.updateUserPreferences(t)}),this.setupLastViewedMoment(),this.setupPreviewModeAlert(),null!==this.autoPlay&&this.autoPlay.configureComponents(localStorage,this.myPlayer),this.sendCanPlayToAnalytics()}},{key:"sendCanPlayToAnalytics",value:function(){try{navigator.mediaCapabilities.decodingInfo({type:"media-source",audio:{contentType:"audio/mp4; codecs=mp4a.40.2",channels:"2",bitrate:132266,samplerate:48e3},video:{contentType:"video/mp4; codecs=avc1.42E01E",width:1920,height:1080,bitrate:2646242,framerate:"30"}}).then(function(e){try{e.supported||ga("send","event",{eventCategory:"video",eventAction:"canNotPlayMp4",eventLabel:"canNotPlayMp4",eventValue:!e.supported,nonInteraction:!0})}catch(e){console.error(e)}})}catch(e){console.error(e)}}},{key:"setupPreviewModeAlert",value:function(){var a,o,e;this.isOnPreviewMode&&((a=this.myPlayer.createModal("",{pauseOnOpen:!1,temporary:!1,description:"Modal de alerta ao mode de preview do curso"})).addClass("preview-mode"),a.contentEl_.innerHTML=document.querySelector(".task-body-alert").innerHTML,a.close(),o=!1,e=function t(){o||setTimeout(function(){a.open(),o=!0;var e=setTimeout(function(){a.close(),clearTimeout(t),clearTimeout(e)},5e3)},5e3)},this.myPlayer.on("playing",e))}},{key:"setupAutoPlay",value:function(){var e,a=this;0!=this.isAutoPlayEnabled&&"undefined"!=typeof AutoPlay&&(e={options:{optionNone:this.$videoData.data("autoplay-menu-option-none"),optionVideos:this.$videoData.data("autoplay-menu-option-videos"),optionTasks:this.$videoData.data("autoplay-menu-option-tasks")},nextTaskModal:{continueText:this.$videoData.data("autoplay-continue-text"),cancelText:this.$videoData.data("autoplay-cancel-text"),nextTaskModalTitle:this.$videoData.data("autoplay-next-task-modal-title"),nextTaskCountDownTitle:this.$videoData.data("next-task-countdown-title")},stillHereModal:{stillHereModalText:this.$videoData.data("autoplay-still-here-modal-text")}},this.autoPlay=new AutoPlay(this.nextTaskId,this.nextTaskTitle,this.nextTaskDuration,this.autoPlayType,this.taskId,e,{ga:function(e,t){a.doAnalytics(e,t)}}))}},{key:"setupLastViewedMoment",value:function(){var e,t=this,a=this.category+(this.taskId||this.extraContentId||this.immersionClassId);this.myPlayer.on("play",function(){e=t.lastMomentManager.updateRegistryMomentListener(function(){return{registryId:a,currentTime:t.myPlayer.currentTime()}},5e3,t.myPlayer.duration())}),this.myPlayer.on("pause",function(){clearInterval(e)});var o=this.lastMomentManager.getActualTimeForRegistry(a);this.myPlayer.currentTime(o)}},{key:"getResumeId",value:function(){return this.category+(this.taskId||this.extraContentId||this.immersionClassId)}},{key:"setupError",value:function(){var t=this;this.myPlayer.on("error",function(){var e=t.myPlayer.error();void 0!==t.diagnostic&&t.diagnostic.appendError(e),console.error(e.message),t.myPlayer.error(null),t.doAnalytics("code[".concat(e.code,"] message[").concat(e.message,"]"),"videoError");e=new(videojs.getComponent("ModalDialog"))(t.myPlayer,t.buildErrorModalOptions());e.addClass("vjs-error-modal"),e.open(),$(e.el()).html(t.customErrorMessage),t.myPlayer.addChild(e)})}},{key:"buildErrorModalOptions",value:function(){return{content:this.customErrorMessage,description:this.customErrorLabel,label:this.customErrorLabel,pauseOnOpen:!0,temporary:!1,uncloseable:!0}}},{key:"buildSources",value:function(e){var t=this;return e.map(function(e){return t.buildSource(e)})}},{key:"buildSource",value:function(e){var t="video/mp4",a=e.link;return this.myPlayer.canPlayType("video/mp4")?e.link.includes("index.m3u8")&&(t="application/x-mpegURL"):e.linkWebm&&(t='video/webm; codecs="vp9, opus"',(a=e.linkWebm).includes("manifest.mpd")&&(t="application/dash+xml")),{src:a,type:t,label:e.quality,selected:this.quality==e.quality}}},{key:"setupPlaybackRate",value:function(){var t=this;(0==this.playbackRate||this.playbackRate>Math.max.apply(Math,_toConsumableArray(this.playbackRates)))&&(this.playbackRate=1,this.canSendUserPreferences=!0),this.myPlayer.playbackRate(this.playbackRate),this.myPlayer.on("ratechange",function(){var e=t.myPlayer.playbackRate();t.playbackRate=e,t.canSendUserPreferences&&$.post("/user/profile/setPlaybackRate",{rate:e}),t.doAnalytics(e,"ratechange")})}},{key:"doAnalytics",value:function(e,t){try{ga("send","event",{eventCategory:this.category,eventAction:t,eventLabel:this.label,eventValue:e,nonInteraction:!0})}catch(e){console.error(e)}}},{key:"setupWatched",value:function(){var e=this;this.myPlayer.on("play",function(){return!!e.alreadyStarted||(e.setupPlaybackRate(),e.canSendUserPreferences=!0,e.extraContentId?e.markViewedExtraContent():(e.courseId&&e.markTaskViewed(),!0))})}},{key:"markTaskViewed",value:function(){var e=this,t={courseCode:this.courseCode,videoTaskId:this.taskId};$.post("/course/"+this.courseCode+"/task/"+this.taskId+"/mark-video",t,function(){e.changeIcon(),e.alreadyStarted=!0})}},{key:"markViewedExtraContent",value:function(){var e=new ExtraContentProgressRequest,t=this;return this.taskId?e.callEndpointTask(this.taskId,function(){t.changeIcon(),t.alreadyStarted=!0}):e.callEndpoint(this.extraContentId,function(){t.changeIcon(),t.alreadyStarted=!0}),!0}},{key:"changeIcon",value:function(){var e,t=$(".task-menu-nav-item--selected .task-menu-nav-item-svg");t.hasClass("task-menu-nav-item-svg--done")||(e=t.attr("class"),t.attr("class",e+" task-menu-nav-item-svg--done"))}},{key:"updateUserPreferences",value:function(e){e=e.label;this.canSendUserPreferences&&$.post("/user/profile/setMovieQuality",{quality:e})}},{key:"setupPersistVolume",value:function(){var e=this,t=localStorage.getItem("gnarus-player-volume");t&&this.myPlayer.volume(t),this.myPlayer.on("volumechange",function(){localStorage.setItem("gnarus-player-volume",e.myPlayer.volume())})}},{key:"shouldIgnoreEvent",value:function(e){return $(e.target).is("#courseNotebook-text")||$(e.target).is("#query")||$(e.target).is("#headerBusca-campoBusca")||e.ctrlKey}},{key:"setupHotKeys",value:function(){var t=this;$(window).on("keydown",function(e){if(!t.shouldIgnoreEvent(e))switch(e.keyCode){case 75:case 32:t.showControlBar(),e.preventDefault(),t.togglePlay();break;case 70:t.showControlBar(),e.preventDefault(),t.toggleFullScreen();break;case 77:t.showControlBar(),t.toggleMute();break;case 37:t.showControlBar(),t.seek(-10);break;case 39:t.showControlBar(),t.seek(10);break;case 88:t.showControlBar(),t.nextPlaybackRate()}})}},{key:"togglePlay",value:function(){this.myPlayer.paused()?this.myPlayer.play():this.myPlayer.pause()}},{key:"toggleFullScreen",value:function(){this.myPlayer.isFullscreen()?this.myPlayer.exitFullscreen():this.myPlayer.requestFullscreen()}},{key:"toggleMute",value:function(){this.myPlayer.muted(!this.myPlayer.muted())}},{key:"seek",value:function(e){var t=this.myPlayer.currentTime();this.myPlayer.currentTime(t+e)}},{key:"nextPlaybackRate",value:function(){var e=this.myPlayer.playbackRate(),t=this.playbackRates.indexOf(e),e=this.playbackRates.length,a=this.playbackRates[((t+1)%e+e)%e];this.myPlayer.playbackRate(a)}},{key:"changeVolume",value:function(e){var t=this.myPlayer.volume();this.myPlayer.volume(t+e),$(".vjs-volume-panel").addClass("vjs-hover"),setTimeout(function(){return $(".vjs-volume-panel").removeClass("vjs-hover")},1e3)}},{key:"showControlBar",value:function(){var e=this;this.myPlayer.userActive(!0),setTimeout(function(){return e.myPlayer.userActive(!1)},1e3)}}]),e}();